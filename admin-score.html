<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Score Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .score-display {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .batting-team {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .score {
            font-size: 36px;
            font-weight: bold;
            color: #e74c3c;
            margin: 5px 0;
        }
        .overs {
            font-size: 20px;
            color: #7f8c8d;
        }
        .this-over {
            margin-top: 15px;
            font-size: 18px;
        }
        .this-over span {
            display: inline-block;
            margin: 0 5px;
            font-weight: bold;
        }
        .button-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        .action-btn {
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .action-btn:active {
            transform: translateY(0);
        }
        .run-btn {
            background-color: #2ecc71;
            color: white;
        }
        .wicket-btn {
            background-color: #e74c3c;
            color: white;
        }
        .extra-btn {
            background-color: #f39c12;
            color: white;
        }
        .nb-active {
            background-color: #9b59b6;
            color: white;
        }
        .custom-container {
            margin-top: 20px;
        }
        .custom-input {
            padding: 10px;
            width: 60px;
            font-size: 16px;
            margin-right: 10px;
        }
        .custom-btn {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .match-info {
            margin-bottom: 20px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .target-display {
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .nb-run-buttons {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .nb-run-btn {
            padding: 10px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .winner-btn {
            background-color: #27ae60 !important;
            color: white;
            width: 100%;
            padding: 15px !important;
            font-size: 18px !important;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <h1>Score Control</h1>
        <div class="target-display" id="targetDisplay">Target: - </div>
    </div>
    
    <div class="match-info" id="matchInfo">
        Loading match info...
    </div>
    
    <div class="score-display">
        <div class="batting-team" id="battingTeam">-</div>
        <div class="score" id="currentScore">0 - 0</div>
        <div class="overs" id="currentOvers">0.0 / 0 overs</div>
        <div class="this-over">
            This over: <span id="thisOverDisplay"></span>
        </div>
    </div>
    
    <div class="button-container">
        <button class="action-btn run-btn" onclick="handleRunButton('0')">0</button>
        <button class="action-btn run-btn" onclick="handleRunButton('1')">1</button>
        <button class="action-btn run-btn" onclick="handleRunButton('2')">2</button>
        <button class="action-btn run-btn" onclick="handleRunButton('3')">3</button>
        <button class="action-btn run-btn" onclick="handleRunButton('4')">4</button>
        <button class="action-btn run-btn" onclick="handleRunButton('6')">6</button>
        <button class="action-btn wicket-btn" onclick="updateScore('wicket')">Wicket</button>
        <button class="action-btn extra-btn" onclick="updateScore('WD')">WD</button>
        <button class="action-btn extra-btn" id="nbButton" onclick="handleNbButton()">NB</button>
    </div>
    
    <div class="nb-run-buttons" id="nbRunButtons">
        <button class="nb-run-btn" onclick="handleNbRun('0')">NB + 0</button>
        <button class="nb-run-btn" onclick="handleNbRun('1')">NB + 1</button>
        <button class="nb-run-btn" onclick="handleNbRun('2')">NB + 2</button>
        <button class="nb-run-btn" onclick="handleNbRun('3')">NB + 3</button>
        <button class="nb-run-btn" onclick="handleNbRun('4')">NB + 4</button>
        <button class="nb-run-btn" onclick="handleNbRun('6')">NB + 6</button>
    </div>


    
    <div class="custom-container">
        <input type="number" id="customRun" class="custom-input" min="0" placeholder="Runs">
        <button class="custom-btn" onclick="updateScore('custom')">Add Custom Run</button>
    </div>
    
    <button class="action-btn winner-btn" onclick="showWinnerModal()" style="margin-top: 20px; background-color: #27ae60;">Declare Winner</button>

    <!-- Winner Modal -->
    <div id="winnerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h2 style="margin-top: 0;">Declare Match Winner</h2>
            
            <div style="margin-bottom: 15px;">
                <label>Winning Team:</label>
                <select id="winnerTeam" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="team1">Team 1</option>
                    <option value="team2">Team 2</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label>Winning Margin:</label>
                <div style="display: flex; margin-top: 5px;">
                    <input type="number" id="winMargin" style="flex: 1; padding: 8px; margin-right: 10px;" min="1" placeholder="Margin">
                    <select id="winType" style="flex: 1; padding: 8px;">
                        <option value="runs">Runs</option>
                        <option value="wickets">Wickets</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end;">
                <button onclick="hideWinnerModal()" style="padding: 8px 15px; margin-right: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px;">Cancel</button>
                <button onclick="submitWinner()" style="padding: 8px 15px; background: #27ae60; color: white; border: none; border-radius: 4px;">Submit</button>
            </div>
        </div>
    </div>
       
    
    
    <script>
        let nbActive = false;
        
        // DOM elements cache
        const domElements = {
            matchInfo: document.getElementById('matchInfo'),
            battingTeam: document.getElementById('battingTeam'),
            currentScore: document.getElementById('currentScore'),
            currentOvers: document.getElementById('currentOvers'),
            targetDisplay: document.getElementById('targetDisplay'),
            thisOverDisplay: document.getElementById('thisOverDisplay'),
            nbButton: document.getElementById('nbButton'),
            nbRunButtons: document.getElementById('nbRunButtons'),
            winnerModal: document.getElementById('winnerModal'),
            winnerTeam: document.getElementById('winnerTeam'),
            winMargin: document.getElementById('winMargin'),
            winType: document.getElementById('winType'),
            customRun: document.getElementById('customRun')
        };
    
        // Initialize event listeners
        function initializeEventListeners() {
            // Run buttons
            document.querySelectorAll('.run-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const runs = this.getAttribute('data-runs');
                    if (runs) {
                        handleRunButton(runs);
                    }
                });
            });
    
            // Custom run button
            const customRunBtn = document.getElementById('customRunBtn');
            if (customRunBtn) {
                customRunBtn.addEventListener('click', function() {
                    const customRun = domElements.customRun?.value;
                    if (!customRun || isNaN(customRun)) {
                        alert('Please enter a valid run value');
                        return;
                    }
                    updateScore(customRun);
                });
            }
    
            // NB button
            if (domElements.nbButton) {
                domElements.nbButton.addEventListener('click', handleNbButton);
            }
        }
    
        function fetchMatchInfo() {
            fetch('/api/score')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    console.log("Received data:", data);
                    if (data) {
                        updateUI(data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching match info:', error);
                    if (domElements.matchInfo) {
                        domElements.matchInfo.innerHTML = 'Error loading match data';
                    }
                });
        }
    
        function updateUI(data) {
            if (!data) return;
    
            // Update match info
            if (domElements.matchInfo) {
                domElements.matchInfo.innerHTML = `
                    <strong>${data.team1 || 'Team 1'}</strong> vs <strong>${data.team2 || 'Team 2'}</strong> | 
                    Toss: ${data.tossWinner === 'team1' ? data.team1 : data.team2} ${data.tossDecision === 'bat' ? 'bat' : 'bowl'}
                `;
            }
            
            // Update score display
            const battingTeam = data.currentBatting == 1 ? data.team1 : data.team2;
            if (domElements.battingTeam) domElements.battingTeam.textContent = battingTeam;
            if (domElements.currentScore) {
                domElements.currentScore.textContent = `${data.currentRuns || 0} - ${data.currentWickets || 0}`;
            }
            if (domElements.currentOvers) {
                domElements.currentOvers.textContent = 
                    `${parseFloat(data.currentOvers || 0).toFixed(1)} / ${data.totalOvers || 0} overs`;
            }
           
            // Update target display
            if (domElements.targetDisplay) {
                if (data.battingPhase === 'first') {
                    domElements.targetDisplay.textContent = 'First Innings';
                } else if (data.targetScore) {
                    domElements.targetDisplay.textContent = `Target: ${data.targetScore}`;
                } else {
                    domElements.targetDisplay.textContent = 'Target: -';
                }
            }
                
            // Update this over display
            if (domElements.thisOverDisplay) {
                const thisOver = data.thisOver || '';
                domElements.thisOverDisplay.innerHTML = 
                    thisOver.split(',').filter(Boolean).map(ball => 
                        `<span class="ball-${ball.trim()}">${ball.trim()}</span>`
                    ).join(' ');
            }
        }
        
        function handleNbButton() {
            nbActive = !nbActive;
            if (domElements.nbButton) {
                domElements.nbButton.classList.toggle('nb-active', nbActive);
            }
            if (domElements.nbRunButtons) {
                domElements.nbRunButtons.style.display = nbActive ? 'grid' : 'none';
            }
        }
        
        function handleNbRun(runs) {
            if (!runs) return;
            updateScore('NB', parseInt(runs));
            handleNbButton();
        }
        
        function handleRunButton(runs) {
            if (!runs) return;
            
            if (nbActive) {
                handleNbRun(runs);
            } else {
                updateScore(runs);
            }
        }
        
        function updateScore(action, additionalRuns = null) {
            // Prepare payload based on action type
            const payload = {
                action: action.toString()
            };
        
            // Handle special cases
            if (action === 'NB' && additionalRuns !== null) {
                payload.nbAdditionalRuns = parseInt(additionalRuns);
                payload.displayText = `NB+${additionalRuns}`;
            } else if (action === 'custom') {
                const customRun = document.getElementById('customRun').value;
                if (!customRun || isNaN(customRun)) {
                    alert('Please enter a valid run value');
                    return;
                }
                payload.customRun = customRun;
            }
        
            console.log("Sending update:", payload);
        
            fetch('/api/update-score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Update failed');
                }
                return data;
            })
            .then(data => {
                console.log("Update successful:", data);
                // Update UI immediately
                document.getElementById('currentScore').textContent = 
                    `${data.currentRuns} - ${data.currentWickets}`;
                
                document.getElementById('currentOvers').textContent = 
                    `${data.currentOvers} / ${data.totalOvers} overs`;
                
                // Show only current over (last 6 balls)
                const currentOverBalls = data.fullOverHistory.split(',').slice(-6);
                document.getElementById('thisOverDisplay').innerHTML = 
                    currentOverBalls.map(ball => {
                        if (ball === 'W') return `<span class="ball-W">W</span>`;
                        if (ball === 'WD') return `<span class="ball-WD">WD</span>`;
                        if (ball.startsWith('NB')) return `<span class="ball-NB">${ball}</span>`;
                        if (ball === '4') return `<span class="ball-4">4</span>`;
                        if (ball === '6') return `<span class="ball-6">6</span>`;
                        return `<span class="ball-${ball}">${ball}</span>`;
                    }).join(' ');
            })
            .catch(error => {
                console.error('Update error:', error);
                alert(`Update failed: ${error.message}`);
            });
        }
        
        // NB Button handler
        function handleNbButton() {
            nbActive = !nbActive;
            document.getElementById('nbButton').classList.toggle('active', nbActive);
            document.getElementById('nbRunButtons').style.display = nbActive ? 'grid' : 'none';
        }
        
        // Run button handler
        function handleRunButton(runs) {
            if (nbActive && runs !== 'W') { // Can't have NB + W
                handleNbRun(runs);
            } else {
                updateScore(runs);
            }
        }
        
        // NB Run handler
        function handleNbRun(runs) {
            updateScore('NB', runs);
            handleNbButton(); // Turn off NB mode
        }
        
        function showWinnerModal() {
            if (domElements.winnerModal) {
                domElements.winnerModal.style.display = 'flex';
                fetch('/api/score')
                    .then(response => response.json())
                    .then(data => {
                        if (data.team1 && data.team2 && domElements.winnerTeam) {
                            domElements.winnerTeam.innerHTML = `
                                <option value="team1">${data.team1}</option>
                                <option value="team2">${data.team2}</option>
                            `;
                        }
                    });
            }
        }
        
        function hideWinnerModal() {
            if (domElements.winnerModal) {
                domElements.winnerModal.style.display = 'none';
            }
        }
        
        function submitWinner() {
            if (!domElements.winnerTeam || !domElements.winMargin || !domElements.winType) return;
            
            const winningTeam = domElements.winnerTeam.value;
            const winMargin = domElements.winMargin.value;
            const winType = domElements.winType.value;
            
            if (!winMargin || isNaN(winMargin) || winMargin < 1) {
                alert('Please enter a valid positive margin');
                return;
            }
            
            fetch('/api/set-winner', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    winningTeam,
                    winMargin: parseInt(winMargin),
                    winType
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to declare winner');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    hideWinnerModal();
                    alert('Winner declared successfully!');
                    fetchMatchInfo();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'Error declaring winner');
            });
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            
            // Add winner modal buttons if they exist
            const declareWinnerBtn = document.getElementById('declareWinnerBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const submitWinnerBtn = document.getElementById('submitWinnerBtn');
            
            if (declareWinnerBtn) declareWinnerBtn.addEventListener('click', showWinnerModal);
            if (closeModalBtn) closeModalBtn.addEventListener('click', hideWinnerModal);
            if (submitWinnerBtn) submitWinnerBtn.addEventListener('click', submitWinner);
            
            // Initial load
            fetchMatchInfo();
        });
        
        // Fetch match info every 2 seconds
        setInterval(fetchMatchInfo, 2000);
    </script>
    
</body>
</html>